<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js "></script>
<title>Raphaël入門2</title>
</head>
<body>
	<h1>変化する曲線に沿って円を移動させる</h1>
    <div id="svg"></div>
    <script>
		var paper = new Raphael("svg", 800, 400);
		
		// 曲線
		var linePath = [
		   ["M", 50, 30], 
		   ["C", 200, 50, 50, 150, 200, 150]
		];
		
		var curveLine = paper.path(linePath);
		curveLine.attr({
		   'stroke' : '#CD5C5C',
		   'stroke-width' : 3,
		});
		
		// 円
		var circle = paper.circle(0, 0, 7);
		circle.attr({
		   fill : "#0000FF"
		});
		
		// 曲線と円を関連づける  
		circle.line = curveLine;
		
		paper.customAttributes.refresh = function (v) {
		   var len = this.line.getTotalLength();
		   var point = this.line.getPointAtLength(v * len);
		   return {
		       transform: "t" + [point.x, point.y]
		   };
		};
				
		function run() {
		    circle.animate({refresh: 1}, 1000, function () {
		        circle.attr({refresh: 0});
		        setTimeout(run)
		    });
		};   

		// 補助線と端点を作成する
		var subLinePath = [
		   ["M", linePath[0][1], linePath[0][2]],
		   ["L", linePath[1][1], linePath[1][2]],
		   ["M", linePath[1][3], linePath[1][4]],
		   ["L", linePath[1][5], linePath[1][6]]
		];
		var cornerAttr = {fill: "#000", stroke: "none"};
		var controls = paper.set(
		       paper.path(subLinePath).attr({stroke: "#111", "stroke-dasharray": ". "}),
		       paper.circle(linePath[0][1], linePath[0][2], 5).attr(cornerAttr),
		       paper.circle(linePath[1][1], linePath[1][2], 5).attr(cornerAttr),
		       paper.circle(linePath[1][3], linePath[1][4], 5).attr(cornerAttr),
		       paper.circle(linePath[1][5], linePath[1][6], 5).attr(cornerAttr)
		);
		
		// ドラッグ時の処理
		function dragOnMove(dx, dy, x, y, event) {
		   this.update(dx - diffX, dy - diffY);
		   diffX = dx;
		   diffY = dy;
		}
		
		// ドラッグ開始時の処理
		function dragOnStart(x, y, event) {
		   diffX = 0;
		   diffY = 0;
		}
		
		// 補助線と端点にドラッグ操作を関連づける
		controls.drag(dragOnMove, dragOnStart);

		// ドラッグ時に呼ばれる描画更新処理
		controls[1].update = function (x, y) {
		   var X = this.attr("cx") + x;
		   var Y = this.attr("cy") + y;
		   this.attr({cx: X, cy: Y});
		   linePath[0][1] = X;
		   linePath[0][2] = Y;
		   subLinePath[0][1] = X;
		   subLinePath[0][2] = Y;
		   controls[2].update(x, y);
		};
		controls[2].update = function (x, y) {
		   var X = this.attr("cx") + x;
		   var Y = this.attr("cy") + y;
		   this.attr({cx: X, cy: Y});
		   linePath[1][1] = X;
		   linePath[1][2] = Y;
		   subLinePath[1][1] = X;
		   subLinePath[1][2] = Y;
		   curveLine.attr({path: linePath});
		   controls[0].attr({path: subLinePath});
		};
		controls[3].update = function (x, y) {
		   var X = this.attr("cx") + x;
		   var Y = this.attr("cy") + y;
		   this.attr({cx: X, cy: Y});
		   linePath[1][3] = X;
		   linePath[1][4] = Y;
		   subLinePath[2][1] = X;
		   subLinePath[2][2] = Y;
		   curveLine.attr({path: linePath});
		   controls[0].attr({path: subLinePath});
		};
		controls[4].update = function (x, y) {
		   var X = this.attr("cx") + x;
		   var Y = this.attr("cy") + y;
		   this.attr({cx: X, cy: Y});
		   linePath[1][5] = X;
		   linePath[1][6] = Y;
		   subLinePath[3][1] = X;
		   subLinePath[3][2] = Y;
		   controls[3].update(x, y);
		};
		
		run();
    </script>
</body>
</html>
